<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stream</title>
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/products.css" />
  </head>
  <body>
    <div class="container">
      <div class="header">
        <a href="/" class="back-link">‚Üê Back to Home</a>
        <h1>Products</h1>
        <p class="subtitle">Browse available products and make a purchase</p>
      </div>

      <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Loading products...</p>
      </div>

      <div id="error" class="error-message" style="display: none">
        <p>Failed to load products. Please try again later.</p>
      </div>

      <div id="products-grid" class="products-grid">
        <!-- Products will be loaded here dynamically -->
      </div>

      <footer class="footer">
        <p>
          To enable/disable payment link installments, visit
          <a
            href="https://app.streampay.sa/settings/payment-settings"
            target="_blank"
            rel="noopener noreferrer"
            >Settings</a
          >
        </p>
      </footer>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Enter Customer Details</h2>
          <button class="modal-close" onclick="closeCheckoutModal()">&times;</button>
        </div>
        <form id="checkout-form" onsubmit="handleCheckoutSubmit(event)">
          <div class="form-group">
            <label for="payment-link-name">Payment Link Name *</label>
            <input
              type="text"
              id="payment-link-name"
              name="name"
              placeholder="e.g., Zoo trip"
              required
            />
          </div>
          <div class="form-group">
            <label for="customer-name">Customer Name</label>
            <input
              type="text"
              id="customer-name"
              name="customerName"
              placeholder="e.g., Ahmed Ali"
            />
            <small>Optional - Both name and phone required if filling customer details</small>
          </div>
          <div class="form-group">
            <label for="customer-phone">Customer Phone</label>
            <div class="phone-input-wrapper" id="phone-wrapper">
              <span class="phone-prefix">+966</span>
              <input
                type="tel"
                id="customer-phone"
                name="customerPhone"
                placeholder="501234567"
                pattern="^[0-9]{9,10}$"
              />
            </div>
            <small>Optional - Both name and phone required if filling customer details</small>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="closeCheckoutModal()">
              Cancel
            </button>
            <button type="submit" class="btn-primary">Proceed to Checkout</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Fetch and display products
      async function loadProducts() {
        const loading = document.getElementById("loading");
        const error = document.getElementById("error");
        const grid = document.getElementById("products-grid");

        try {
          // Fetch products only
          const response = await fetch("/api/products?size=100");

          if (!response.ok) {
            throw new Error("Failed to fetch products");
          }

          const data = await response.json();
          const products = data.data || [];

          loading.style.display = "none";

          if (products.length === 0) {
            grid.innerHTML =
              '<p class="no-products">Please create products on <a href="https://app.streampay.sa"> Stream dashboard.</a> They&apos;ll show here</p>';
            return;
          }

          grid.innerHTML = products
            .map((product) => {
              const productType = product.type || "ONE_OFF";

              return `
              <div class="product-card">
                <div class="product-info">
                  <h3 class="product-name">${escapeHtml(product.name || "Product")}</h3>
                  <p class="product-description">${escapeHtml(product.description || "")}</p>
                  <div class="product-meta">
                    <span class="product-type">${formatProductType(productType, null, null)}</span>
                  </div>
                  <div class="product-footer">
                    <div class="product-price">
                      ${getCurrencySymbol(product.currency || "SAR")}
                      <span class="amount">${formatPrice(product.price || 0)}</span>
                    </div>
                    <div class="product-actions">
                      <button class="buy-button" onclick="checkoutProduct('${product.id}')">
                        Pay now
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `;
            })
            .join("");
        } catch (err) {
          console.error("Error loading products:", err);
          loading.style.display = "none";
          error.style.display = "block";
        }
      }

      // Store selected product ID for checkout
      let selectedProductId = null;

      // Open checkout modal
      function checkoutProduct(productId) {
        if (productId) {
          selectedProductId = productId;
          const modal = document.getElementById("checkout-modal");
          modal.style.display = "flex";
          // Focus on first input
          setTimeout(() => {
            document.getElementById("payment-link-name").focus();
          }, 100);
        } else {
          alert("Invalid product. Please try again.");
        }
      }

      // Close checkout modal
      function closeCheckoutModal() {
        const modal = document.getElementById("checkout-modal");
        modal.style.display = "none";
        selectedProductId = null;
        // Reset form
        document.getElementById("checkout-form").reset();
      }

      // Handle checkout form submission
      function handleCheckoutSubmit(event) {
        event.preventDefault();

        if (!selectedProductId) {
          alert("No product selected. Please try again.");
          return;
        }

        const formData = new FormData(event.target);
        const paymentLinkName = formData.get("name");
        const customerName = formData.get("customerName");
        const customerPhone = formData.get("customerPhone");

        // Validate that both name and phone are provided together or both are empty
        if ((customerName && !customerPhone) || (!customerName && customerPhone)) {
          alert("Please provide both customer name and phone number, or leave both empty.");
          return;
        }

        // Build checkout URL with query parameters
        let checkoutUrl = `/api/checkout?products=${encodeURIComponent(selectedProductId)}`;

        if (paymentLinkName) {
          checkoutUrl += `&name=${encodeURIComponent(paymentLinkName)}`;
        }

        if (customerName && customerPhone) {
          checkoutUrl += `&customerName=${encodeURIComponent(customerName)}`;
          // Prepend +966 to phone number
          const fullPhoneNumber = "+966" + customerPhone;
          checkoutUrl += `&customerPhone=${encodeURIComponent(fullPhoneNumber)}`;
        }

        // Redirect to checkout
        window.location.href = checkoutUrl;
      }

      // Add focus/blur handlers for phone input wrapper
      document.addEventListener("DOMContentLoaded", function () {
        const phoneInput = document.getElementById("customer-phone");
        const phoneWrapper = document.getElementById("phone-wrapper");

        if (phoneInput && phoneWrapper) {
          phoneInput.addEventListener("focus", function () {
            phoneWrapper.classList.add("focused");
          });

          phoneInput.addEventListener("blur", function () {
            phoneWrapper.classList.remove("focused");
          });

          // Click on wrapper focuses the input
          phoneWrapper.addEventListener("click", function () {
            phoneInput.focus();
          });
        }
      });

      // Close modal when clicking outside
      window.onclick = function (event) {
        const modal = document.getElementById("checkout-modal");
        if (event.target === modal) {
          closeCheckoutModal();
        }
      };

      // Helper functions
      function formatPrice(price) {
        return parseFloat(price).toFixed(2);
      }

      function getCurrencySymbol(currency) {
        if (currency === "SAR") {
          return `<svg class="currency-symbol" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1124.14 1256.39">
            <path fill="currentColor" d="M699.62,1113.02h0c-20.06,44.48-33.32,92.75-38.4,143.37l424.51-90.24c20.06-44.47,33.31-92.75,38.4-143.37l-424.51,90.24Z"/>
            <path fill="currentColor" d="M1085.73,895.8c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.33v-135.2l292.27-62.11c20.06-44.47,33.32-92.75,38.4-143.37l-330.68,70.27V66.13c-50.67,28.45-95.67,66.32-132.25,110.99v403.35l-132.25,28.11V0c-50.67,28.44-95.67,66.32-132.25,110.99v525.69l-295.91,62.88c-20.06,44.47-33.33,92.75-38.42,143.37l334.33-71.05v170.26l-358.3,76.14c-20.06,44.47-33.32,92.75-38.4,143.37l375.04-79.7c30.53-6.35,56.77-24.4,73.83-49.24l68.78-101.97v-.02c7.14-10.55,11.3-23.27,11.3-36.97v-149.98l132.25-28.11v270.4l424.53-90.28Z"/>
          </svg>`;
        }
        return `<span class="currency">${currency || "SAR"}</span>`;
      }

      function formatProductType(type, recurringInterval, intervalCount) {
        if (type === "RECURRING" && recurringInterval) {
          const interval = recurringInterval.toLowerCase();
          if (intervalCount && intervalCount > 1) {
            return `Every ${intervalCount} ${interval}s`;
          }
          return interval.charAt(0).toUpperCase() + interval.slice(1) + "ly";
        }

        const types = {
          ONE_OFF: "One-time Purchase",
          RECURRING: "Subscription",
        };
        return types[type] || "One-time Purchase";
      }

      function getProductIcon(type) {
        const icons = {
          ONE_OFF: "üõçÔ∏è",
          RECURRING: "üîÑ",
          MONTHLY: "üìÖ",
          YEARLY: "üìÜ",
        };
        return icons[type] || "üì¶";
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Load products on page load
      loadProducts();
    </script>
  </body>
</html>
